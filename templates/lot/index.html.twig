{% extends 'base.html.twig' %}

{% block title %}Vestige d‚ÄôOr ‚Äî Tous les lots{% endblock %}

{% block body %}
<main class="bg-black text-white py-4" style="min-height:100vh;">
  <div class="container">
    <h1 class="text-center mb-4 text-accent">Nos Lots aux Ench√®res</h1>

  {# üïó Bandeau : si au moins un √©v√®nement se termine dans < 1h #}
  {% set evImminent = null %}
  {% for lot in lots %}
    {% if lot.evenementEnchere is defined and lot.evenementEnchere is not null %}
      {% if lot.evenementEnchere.fermeDansMoinsDuneHeure is defined and lot.evenementEnchere.fermeDansMoinsDuneHeure %}
        {% set evImminent = lot.evenementEnchere %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if evImminent is not null %}
    <div class="alert alert-danger d-flex align-items-center gap-2" role="alert">
      <div class="fs-5">‚è∞</div>
      <div class="flex-grow-1">
        <strong>Fermeture imminente :</strong>
        <span>les ench√®res ferment √†
          {{ evImminent.finAt is defined and evImminent.finAt ? evImminent.finAt|date('H\\hi','Europe/Paris') : '‚Äî' }}.
        </span>
        {% if evImminent.finAt is defined and evImminent.finAt %}
          <span id="countdown-index"
                data-deadline="{{ evImminent.finAt|date('Y-m-d H:i:s','Europe/Paris') }}"
                class="ms-2 fw-bold text-white"></span>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {% if lots is empty %}
    <p class="text-center">Aucun lot disponible pour le moment.</p>
  {% else %}
    <div class="row g-4">
      {% for lot in lots %}
        {% if lot.evenementEnchere is defined and lot.evenementEnchere is not null %}
          {# D√©terminer un √©tat simple c√¥t√© vue √† partir des helpers de l'entit√© #}
          {% set etat = 'termine' %}
          {% if lot.enchereOuverte %}
            {% set etat = 'ouverte' %}
          {% elseif lot.evenementEnchere.debutAt is defined and lot.evenementEnchere.debutAt %}
            {% if 'now'|date('U') < lot.evenementEnchere.debutAt|date('U','Europe/Paris') %}
              {% set etat = 'a_venir' %}
            {% endif %}
          {% endif %}

          <div class="col-12 col-sm-6 col-lg-4">
            <a class="text-decoration-none text-white" href="{{ path('app_lot_show', {id: lot.id}) }}">
              <div class="lot-card {% if etat == 'termine' %}opacity-50{% endif %}">
                <div class="mb-3">
                  {% if lot.imageFilename %}
                    <img src="{{ asset('uploads/' ~ lot.imageFilename) }}" alt="{{ lot.titre|default('Lot') }}" style="height:220px;object-fit:cover;border-radius:8px;">
                  {% else %}
                    <img src="{{ asset('images/demo/commo.png') }}" alt="Aucune image" style="height:220px;object-fit:cover;opacity:0.85;border-radius:8px;">
                  {% endif %}
                </div>
                <div>
                  <h3 class="h5 text-accent mb-1">{{ lot.titre|default('Lot sans titre') }}</h3>
                  <p class="mb-1 text-secondary small">Cat√©gorie : {{ lot.categorie|default('Non sp√©cifi√©e') }}</p>
                  <p class="mb-1 small text-muted">Prix de d√©part : {{ lot.prixDepart is defined ? lot.prixDepart|number_format(2, ',', ' ') : '0,00' }} ‚Ç¨</p>
                  <p class="fw-bold mb-0">Prix actuel : {{ lot.prixActuel is defined ? lot.prixActuel|number_format(2, ',', ' ') : '0,00' }} ‚Ç¨</p>
                  {% if lot.evenementEnchere is defined and lot.evenementEnchere is not null and lot.evenementEnchere.finAt is defined %}
                    <p class="text-muted small mb-0 mt-1">Fin : {{ lot.evenementEnchere.finAt|date('d/m/Y H:i','Europe/Paris') }}</p>
                  {% endif %}

                  {# Petit texte de statut #}
                  <p class="small mt-1 mb-0">
                    {% if etat == 'ouverte' %}
                      <span class="text-success">Ench√®res en cours</span>
                    {% elseif etat == 'a_venir' %}
                      <span class="text-info">Ench√®res √† venir</span>
                    {% else %}
                      {% set final = lot.statutFinal %}
                      {% if final == 'remportee' %}
                        <span class="text-muted">Ench√®re remport√©e</span>
                      {% elseif final == 'annulee' %}
                        <span class="text-muted">Ench√®re annul√©e</span>
                      {% else %}
                        <span class="text-muted">Ench√®res termin√©es</span>
                      {% endif %}
                    {% endif %}
                  </p>
                </div>
              </div>
            </a>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
  </div>
</main>

{% if evImminent %}
<script>
  (function () {
    var el = document.getElementById('countdown-index');
    if (!el) return;
    var dl = el.getAttribute('data-deadline');
    if (!dl) return;

    function tick() {
      var end = new Date(dl.replace(' ', 'T'));
      var now = new Date();
      var diff = end - now;
      if (diff <= 0) { el.textContent = 'Termin√©'; return; }

      var s = Math.floor(diff / 1000);
      var h = Math.floor(s / 3600); s %= 3600;
      var m = Math.floor(s / 60); s %= 60;
      el.textContent = (h>0?h+'h ':'') + (m>0?m+'m ':'') + s + 's';
      requestAnimationFrame(tick);
    }
    tick();
  })();
</script>
{% endif %}
{% endblock %}
