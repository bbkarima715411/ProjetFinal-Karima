{% extends 'base.html.twig' %}

{% block title %}{{ lot.titre|default('Détails du lot') }} — Détails du lot{% endblock %}

{% block body %}
<main class="bg-black text-white py-4" style="min-height:100vh;">
  <div class="container">
    <h1 class="text-center mb-4 text-accent">{{ lot.titre|default('Détails du lot') }}</h1>

    <div class="lot-grid align-items-start">
      <div class="lot-media">
        {% if lot.imageFilename %}
          <img src="{{ asset('uploads/' ~ lot.imageFilename) }}" alt="{{ lot.titre|default('Lot') }}">
        {% else %}
          <img src="{{ asset('images/demo/commo.png') }}" alt="Aucune image">
        {% endif %}
      </div>

      <div class="lot-info">
        <div class="mb-2 text-secondary">Catégorie : {{ lot.categorie|default('Non spécifiée') }}</div>

        {# Badge d'état de l'enchère #}
        {% if etat_enchere is defined %}
          {% if etat_enchere == 'ouverte' %}
            <span class="badge bg-success mb-2">Enchères ouvertes</span>
          {% elseif etat_enchere == 'a_venir' %}
            <span class="badge bg-info mb-2">Enchères à venir</span>
          {% else %}
            <span class="badge bg-danger mb-2">Enchères terminées</span>
          {% endif %}
        {% endif %}

        <div class="price mb-3">
          <div class="d-flex justify-content-between">
            <div>
              <div class="small text-muted">Prix de départ</div>
              <div class="fw-semibold">{{ lot.prixDepart|number_format(2, ',', ' ') }} €</div>
            </div>
            <div class="text-end">
              <div class="small text-muted">Prix actuel</div>
              <div class="fw-bold fs-5 text-accent">{{ lot.prixActuel|number_format(2, ',', ' ') }} €</div>
            </div>
          </div>
          <div class="small text-muted mt-2">Incrément minimum : {{ lot.incrementMin|number_format(2, ',', ' ') }} €</div>
        </div>

        {% if app.user and etat_enchere == 'ouverte' %}
          <form action="{{ path('app_lot_bid', { id: lot.id }) }}" method="post" class="row gy-2 gx-2 align-items-end">
            <input type="hidden" name="_token" value="{{ csrf_token('bid_lot_' ~ lot.id) }}">
            <div class="col-12">
              <label class="form-label">Votre offre (€)</label>
              <input class="form-control bg-dark text-white border-secondary" type="number" name="amount" step="0.01"
                     min="{{ (lot.prixActuel + lot.incrementMin)|number_format(2, '.', '') }}" required>
            </div>
            <div class="col-12 d-flex gap-2 align-items-center">
              <button type="submit" class="btn btn-primary text-white fw-semibold">Enchérir</button>
              <a href="{{ path('app_lot_index') }}" class="btn btn-outline-light">← Retour aux enchères</a>
            </div>
          </form>

          <div class="mt-2 d-flex">
            <div class="ms-auto">
              {# Bouton Favori / Retirer des favoris (formulaires séparés pour éviter les formulaires imbriqués) #}
              {% if is_favorite %}
                <form action="{{ path('app_favori_remove', { id: lot.id }) }}" method="post" class="d-inline">
                  <input type="hidden" name="_token" value="{{ csrf_token('fav_remove_' ~ lot.id) }}">
                  <button class="btn btn-outline-warning" title="Retirer des favoris">★ Retirer</button>
                </form>
              {% else %}
                <form action="{{ path('app_favori_add', { id: lot.id }) }}" method="post" class="d-inline">
                  <input type="hidden" name="_token" value="{{ csrf_token('fav_add_' ~ lot.id) }}">
                  <button class="btn btn-warning text-black" title="Ajouter aux favoris">☆ Favori</button>
                </form>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="alert alert-secondary mt-2" role="alert">
            {% if not app.user %}
              <a href="{{ path('app_login') }}" class="link-warning">Connectez-vous</a> pour déposer une enchère.
            {% elseif etat_enchere == 'a_venir' %}
              Les enchères pour ce lot ne sont pas encore ouvertes.
            {% else %}
              Les enchères pour ce lot sont terminées.
            {% endif %}
          </div>
          <a href="{{ path('app_lot_index') }}" class="btn btn-outline-light">← Retour aux enchères</a>
        {% endif %}
      </div>
    </div>

    {# Historique des enchères pour ce lot #}
    {% if encheres is defined and encheres|length > 0 %}
      <div class="mt-4">
        <h2 class="h5 text-accent mb-3">Historique des enchères</h2>
        <div class="border border-secondary border-opacity-25 rounded-3 overflow-hidden">
          <table class="table table-dark table-sm mb-0">
              <thead>
                <tr>
                  <th scope="col">Date</th>
                  <th scope="col">Enchérisseur</th>
                  <th scope="col" class="text-end">Montant</th>
                </tr>
              </thead>
              <tbody>
                {% for enchere in encheres|sort((a, b) => b.creeLe <=> a.creeLe) %}
                  <tr>
                    <td class="small text-muted">
                      {{ enchere.creeLe|date('d/m/Y H:i','Europe/Paris') }}
                    </td>
                    <td class="small">
                      {% if enchere.user %}
                        {{ enchere.user.firstName ?? '' }} {{ enchere.user.lastName ?? '' }}
                        {% if not enchere.user.firstName and not enchere.user.lastName %}
                          {{ enchere.user.email }}
                        {% endif %}
                      {% else %}
                        Utilisateur inconnu
                      {% endif %}
                    </td>
                    <td class="text-end fw-semibold">
                      {{ enchere.montant|number_format(2, ',', ' ') }} €
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
          </table>
        </div>
      </div>
    {% endif %}

  </div>
</main>
{% set ev = lot.evenementEnchere %}
{% if ev and ev.fermeDansMoinsDuneHeure %}
  <div class="container mt-3">
    <div class="alert alert-danger d-flex align-items-center gap-2" role="alert">
      <div class="fs-5">⏰</div>
      <div class="flex-grow-1">
        <strong>Fermeture imminente :</strong>
        <span>les enchères se terminent aujourd’hui à
          {{ ev.finAt ? ev.finAt|date('H\\hi', 'Europe/Paris') : '—' }}.</span>
        <span id="countdown-show"
              data-deadline="{{ ev.finAt ? ev.finAt|date('Y-m-d H:i:s','Europe/Paris') : '' }}"
              class="ms-2 fw-bold text-white"></span>
      </div>
    </div>
  </div>
{% endif %}
<script>
(function(){
  function startCountdown(el){
    if(!el) return;
    const end = el.getAttribute('data-deadline');
    if(!end) return;
    const endTime = new Date(end.replace(' ', 'T'));
    function tick(){
      const now = new Date();
      let sec = Math.floor((endTime - now)/1000);
      if (sec < 0) { el.textContent = 'Fermé'; return; }
      const h = Math.floor(sec/3600); sec%=3600;
      const m = Math.floor(sec/60); const s = sec%60;
      el.textContent = `(${String(h).padStart(2,'0')}h${String(m).padStart(2,'0')} · ${String(s).padStart(2,'0')}s)`;
      requestAnimationFrame(()=>setTimeout(tick, 250));
    }
    tick();
  }
  startCountdown(document.getElementById('countdown-show'));
})();
</script>


{% endblock %}
