{% extends 'base.html.twig' %}

{% block title %}{{ lot.titre|default('Détails du lot') }} — Détails du lot{% endblock %}

{% block body %}
<main class="bg-black text-white py-4" style="min-height:100vh;">
  <div class="container">
    <h1 class="text-center mb-4 text-accent">{{ lot.titre|default('Détails du lot') }}</h1>

    <div class="row g-4 align-items-start">
      <div class="col-12 col-lg-6">
        <div class="card bg-dark border-0">
          {% if lot.imageFilename %}
            <img class="rounded" src="{{ asset('uploads/' ~ lot.imageFilename) }}" alt="{{ lot.titre|default('Lot') }}">
          {% else %}
            <img class="rounded" src="{{ asset('images/demo/commo.png') }}" alt="Aucune image">
          {% endif %}
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="mb-2 text-secondary">Catégorie : {{ lot.categorie|default('Non spécifiée') }}</div>

        <div class="card bg-dark border-light-subtle mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="small text-muted">Prix de départ</div>
                <div class="fw-semibold">{{ lot.prixDepart|number_format(2, ',', ' ') }} €</div>
              </div>
              <div class="text-end">
                <div class="small text-muted">Prix actuel</div>
                <div class="fw-bold fs-5 text-accent">{{ lot.prixActuel|number_format(2, ',', ' ') }} €</div>
              </div>
            </div>
            <div class="small text-muted mt-2">Incrément minimum : {{ lot.incrementMin|number_format(2, ',', ' ') }} €</div>
          </div>
        </div>

        {% if app.user %}
          <form action="{{ path('app_lot_bid', { id: lot.id }) }}" method="post" class="row gy-2 gx-2 align-items-end">
            <input type="hidden" name="_token" value="{{ csrf_token('bid_lot_' ~ lot.id) }}">
            <div class="col-12">
              <label class="form-label">Votre offre (€)</label>
              <input class="form-control bg-dark text-white border-secondary" type="number" name="amount" step="0.01"
                     min="{{ (lot.prixActuel + lot.incrementMin)|number_format(2, '.', '') }}" required>
            </div>
            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-primary text-white fw-semibold">Enchérir</button>
              <a href="{{ path('app_lot_index') }}" class="btn btn-outline-light">← Retour aux enchères</a>
            </div>
          </form>
        {% else %}
          <div class="alert alert-secondary mt-2" role="alert">
            <a href="{{ path('app_login') }}" class="link-warning">Connectez-vous</a> pour déposer une enchère.
          </div>
          <a href="{{ path('app_lot_index') }}" class="btn btn-outline-light">← Retour aux enchères</a>
        {% endif %}
      </div>
    </div>
  </div>
</main>
{% set ev = lot.evenementEnchere %}
{% if ev and ev.fermeDansMoinsDuneHeure %}
  <div class="container mt-3">
    <div class="alert alert-danger d-flex align-items-center gap-2" role="alert">
      <div class="fs-5">⏰</div>
      <div class="flex-grow-1">
        <strong>Fermeture imminente :</strong>
        <span>les enchères se terminent aujourd’hui à
          {{ ev.finAt ? ev.finAt|date('H\\hi', 'Europe/Paris') : '—' }}.</span>
        <span id="countdown-show"
              data-deadline="{{ ev.finAt ? ev.finAt|date('Y-m-d H:i:s','Europe/Paris') : '' }}"
              class="ms-2 fw-bold text-white"></span>
      </div>
    </div>
  </div>
{% endif %}
<script>
(function(){
  function startCountdown(el){
    if(!el) return;
    const end = el.getAttribute('data-deadline');
    if(!end) return;
    const endTime = new Date(end.replace(' ', 'T'));
    function tick(){
      const now = new Date();
      let sec = Math.floor((endTime - now)/1000);
      if (sec < 0) { el.textContent = 'Fermé'; return; }
      const h = Math.floor(sec/3600); sec%=3600;
      const m = Math.floor(sec/60); const s = sec%60;
      el.textContent = `(${String(h).padStart(2,'0')}h${String(m).padStart(2,'0')} · ${String(s).padStart(2,'0')}s)`;
      requestAnimationFrame(()=>setTimeout(tick, 250));
    }
    tick();
  }
  startCountdown(document.getElementById('countdown-show'));
})();
</script>


{% endblock %}
